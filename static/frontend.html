<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>SSE Session Upload + Query</title>
  <style>
    body { font-family: Inter, Arial, sans-serif; padding:18px; max-width:900px; }
    .row { margin: 10px 0; }
    #log { border:1px solid #eee; padding:8px; height:200px; overflow:auto; background:#fafafa; white-space:pre-wrap; }
    .toast { padding:8px 12px; border-radius:8px; color:#fff; margin-bottom:8px; }
    .toast.warn { background:#d97706; }
    .btn { padding:8px 12px; }
  </style>
</head>
<body>
  <h2>SSE Session Upload + Query (cookie-based sessions)</h2>

  <div class="row">
    <button id="newSessionBtn" class="btn">Get Session (set cookie)</button>
    <span id="sessionId" style="margin-left:12px"></span>
  </div>

  <div class="row">
    <input type="file" id="fileInput" accept="application/pdf" />
    <button id="startBtn" class="btn">Open SSE & Upload</button>
    <span id="status" style="margin-left:12px">idle</span>
  </div>

  <div class="row">
    Upload progress: <progress id="progress" max="100" value="0" style="width:420px; margin-left:10px;"></progress>
  </div>

  <div class="row">
    <div><strong>SSE Log</strong></div>
    <div id="log"></div>
  </div>

  <hr />

  <div class="row">
    <input type="text" id="question" placeholder="Ask (e.g. renewal process?)" style="width:70%" />
    <button id="askBtn" class="btn" disabled>Ask</button>
  </div>

  <div class="row">
    <div><strong>Answer (streaming)</strong></div>
    <div id="answer" style="border:1px solid #ddd; padding:8px; min-height:120px; background:#fff;"></div>
  </div>

<script>
const logEl = document.getElementById('log');
const sessionIdEl = document.getElementById('sessionId');
const newSessionBtn = document.getElementById('newSessionBtn');
const startBtn = document.getElementById('startBtn');
const fileInput = document.getElementById('fileInput');
const progress = document.getElementById('progress');
const status = document.getElementById('status');
const askBtn = document.getElementById('askBtn');
const answerEl = document.getElementById('answer');

function addLog(msg) {
  const d = document.createElement('div');
  d.textContent = `${new Date().toLocaleTimeString()} â€” ${msg}`;
  logEl.appendChild(d);
  logEl.scrollTop = logEl.scrollHeight;
}

async function ensureSession() {
  try {
    const r = await fetch('/session', { method: 'POST' });
    const j = await r.json();
    if (r.ok) {
      sessionIdEl.textContent = j.session_id;
      addLog(`session created ${j.session_id}`);
      return j.session_id;
    }
  } catch (e) {
    addLog('session request failed: ' + e);
  }
  return null;
}

newSessionBtn.onclick = async () => {
  const sid = await ensureSession();
  if (sid) sessionIdEl.textContent = sid;
};

let es = null;
startBtn.onclick = async () => {
  const file = fileInput.files[0];
  if (!file) return alert('Choose a PDF');
  // ensure session exists (server sets cookie)
  let sid = sessionIdEl.textContent;
  if (!sid) {
    sid = await ensureSession();
    if (!sid) return;
  }

  // open SSE to /events (cookie included)
  if (es) es.close();
  es = new EventSource('/events');
  es.onopen = () => addLog('SSE open');
  es.onmessage = (e) => {
    addLog(`[SSE] ${e.data}`);
    if (e.data === 'ingestion_completed') {
      askBtn.disabled = false;
      status.textContent = 'ready to query';
    }
    if (e.data === 'file_uploaded') {
      status.textContent = 'file uploaded';
    }
    if (e.data && e.data.toLowerCase().includes('retrying')) {
      // show toast-like
      const t = document.createElement('div');
      t.className = 'toast warn';
      t.textContent = e.data;
      document.body.appendChild(t);
      setTimeout(()=> t.remove(), 6000);
    }
    if (e.data === '__SESSION_DESTROYED__') {
      addLog('session destroyed by server (TTL expired)');
      es.close();
    }
  };
  es.onerror = () => {
    addLog('SSE error/closed');
  };

  // small wait to ensure session is registered server-side
  await new Promise(r => setTimeout(r, 200));

  // upload
  const form = new FormData();
  form.append('file', file, file.name);

  const xhr = new XMLHttpRequest();
  xhr.open('POST', '/upload', true);
  xhr.upload.onprogress = (evt) => {
    if (evt.lengthComputable) {
      const pct = Math.round((evt.loaded / evt.total) * 100);
      progress.value = pct;
      status.textContent = `Uploading ${pct}%`;
    }
  };
  xhr.onload = () => {
    if (xhr.status >= 200 && xhr.status < 300) {
      addLog('[HTTP] upload accepted by server');
      status.textContent = 'ingestion started';
    } else {
      addLog(`[HTTP] upload failed: ${xhr.status}`);
      status.textContent = 'upload failed';
    }
  };
  xhr.onerror = () => addLog('[HTTP] upload error');
  xhr.send(form);
  addLog('[HTTP] upload started');
  askBtn.disabled = true;
};

askBtn.onclick = async () => {
  const q = document.getElementById('question').value.trim();
  if (!q) return alert('Type a question');
  answerEl.textContent = '';
  addLog('query: ' + q);
  // POST form
  const form = new FormData();
  form.append('question', q);
  form.append('k', '5');

  try {
    const resp = await fetch('/query', { method: 'POST', body: form });
    if (!resp.ok) {
      const txt = await resp.text();
      addLog('query failed: ' + resp.status + ' ' + txt);
      return;
    }
    const reader = resp.body.getReader();
    const dec = new TextDecoder();
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      const chunk = dec.decode(value, { stream: true });
      answerEl.textContent += chunk;
      answerEl.scrollTop = answerEl.scrollHeight;
    }
    addLog('query finished');
  } catch (e) {
    addLog('query error: ' + e);
  }
};
</script>
</body>
</html>
